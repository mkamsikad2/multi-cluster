# multi-cluster
2 kubernetes clusters on kind running a cluster mesh

You must have docker, kind and flux installed first

1. Create the kind clusters:
```
export KUBECONFIG=./cluster1.kube
kind create cluster --config=./cluster-def/cluster1.yaml
export KUBECONFIG=./cluster2.kube
kind create cluster --config=./cluster-def/cluster2.yaml
KUBECONFIG=./cluster1.kube:./cluster2.kube
kubectl config view --flatten > multicluster.kube
export KUBECONFIG=./multicluster.kube
```

2. On each cluster, install cilium using helm ensuring that the pod cidr ranges do not overlap:
```
docker pull quay.io/cilium/cilium:v1.16.5
kind load docker-image quay.io/cilium/cilium:v1.16.5  --name  cluster1
kind load docker-image quay.io/cilium/cilium:v1.16.5  --name  cluster2

helm repo add cilium https://helm.cilium.io/
helm install cilium cilium/cilium --version 1.16.5 \
  --namespace kube-system \
  --set image.pullPolicy=IfNotPresent \
  --set ipam.mode=kubernetes \
  --kube-context kind-cluster1

helm install cilium cilium/cilium --version 1.16.5 \
  --namespace kube-system \
  --set image.pullPolicy=IfNotPresent \
  --set ipam.mode=kubernetes \
  --kube-context kind-cluster2
         
```

4. Install cert-mananger
```
helm repo add jetstack https://charts.jetstack.io
helm install \
  cert-manager jetstack/cert-manager \
  --namespace cert-manager \
  --create-namespace \
  --version v1.6.3 \
  --set installCRDs=true \
  --kube-context kind-cluster1

helm install \
  cert-manager jetstack/cert-manager \
  --namespace cert-manager \
  --create-namespace \
  --version v1.6.3 \
  --set installCRDs=true \
  --kube-context kind-cluster2
```

5. Create a certificate that can be used as Ciliums common CA for both clusters
```openssl req -newkey rsa:2048 -nodes -keyout private_key.pem -x509 -days 3650 -out public_certificate.pem -subj "/CN=Cilium CA"```

6. On each cluster, create a cert-manager issuer and the certificate using the files generated by step 5:
```

cat <<EOF > cilium-ca-certificate.yaml
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: cilium-issuer
  namespace: kube-system
spec:
  ca:
    secretName: cilium-issuer
---
EOF
kubectl -n kube-system create secret tls cilium-issuer --cert=public_certificate.pem --key=private_key.pem --dry-run=client -oyaml >> cilium-ca-certificate.yaml
kubectl apply -f cilium-ca-certificate.yaml --context kind-cluster1
kubectl apply -f cilium-ca-certificate.yaml --context kind-cluster2
```

7. For each cluster expose the kube-dns service with a Loadbalancer
```
cat <<EOF > kube-dns-svc-ip-cluster1.yaml
spec:
  type: ClusterIP
  loadBalancerIP: 172.18.0.101
EOF
kubectl -n kube-system patch svc kube-dns --patch-file kube-dns-svc-ip-cluster1.yaml --context kind-cluster1

cat <<EOF > kube-dns-svc-ip-cluster2.yaml
spec:
  type: ClusterIP
  loadBalancerIP: 172.18.0.201
EOF
kubectl -n kube-system patch svc kube-dns --patch-file kube-dns-svc-ip-cluster2.yaml --context kind-cluster2


kubectl  -n kube-system patch svc kube-dns --patch '{ "spec": { "type": "ClusterIP", "loadBalancerIP": "172.18.0.101" } }' --context kind-cluster1
to do patch core dns service

```

6. On both clusters, update coredns config to perform redirection for both clusters
```
kubectl -n kube-system delete cm coredns --context kind-cluster1
kubectl -n kube-system apply -f coredns-cm-cluster1.yaml --context kind-cluster1
kubectl -n kube-system rollout restart deploy/coredns --context kind-cluster1

kubectl -n kube-system delete cm coredns --context kind-cluster2
kubectl -n kube-system apply -f coredns-cm-cluster2.yaml --context kind-cluster2
kubectl -n kube-system rollout restart deploy/coredns --context kind-cluster2
```

7. Update cilium using helm

8. Deploy sample apps

9. Test

10. Delete
kind delete cluster -n cluster1
kind delete cluster -n cluster2

